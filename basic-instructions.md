1. **Scope**

* Input channel: WhatsApp Business number via **Green API**.
* Supported user functions (v1):

  * List products.
  * Add a new product.
* SKU for new products must be generated by the system.

2. **Flow activation**

* The inventory flow starts only when the first inbound message equals a predefined trigger code string.
* If the first inbound message is not the trigger code, this flow must not start and must not interfere with other Green API automations on the same number.
* Trigger match must ignore leading and trailing whitespace and letter case.

3. **Conversation flow requirements**

* After trigger, the system must prompt the user to choose one of:

  * `list`
  * `add`
  * `cancel`
* After completing an action, the system must return to the same intent prompt while the session is active, until `cancel` or timeout.

4. **List products requirements**

* When user selects `list`, the system must fetch products from WooCommerce and reply with a readable list.
* If the list is long, the system must support pagination through a follow up user reply (example: `more`) within the same active session.

5. **Add product requirements**

* When user selects `add`, the system must request product input.
* The system must accept product input as WhatsApp text in at least one supported structured format.
* The system must validate required fields before proceeding.
* The system must generate an SKU for the new product if SKU is not provided. In v1, SKU must always be generated regardless of user input.
* Before creating the product, the system must send a confirmation summary and require explicit confirmation (`yes` to apply, `no` to abort or re enter).

6. **Parsing and OpenAI usage**

* Deterministic parsing must be attempted first.
* If deterministic parsing fails or required fields are missing, the system must use an OpenAI request to transform the raw user message into the required structured data for product creation.
* OpenAI output must be validated against a strict schema. If validation fails, the user must be asked for the missing or invalid fields.

7. **External integrations**

* The system must trigger outbound HTTP requests for:

  * Fetching product list from WooCommerce.
  * Creating a new product in WooCommerce.
* The system must trigger outbound HTTP requests to OpenAI only for parsing or normalization, not for business logic.
* Every HTTP request must be wrapped in try/catch with error logging:
  * Network errors (fetch failure) must be caught and logged.
  * Non-OK responses must log status code and response body.
  * JSON parsing errors must be caught and logged.
  * All errors must throw custom error classes with appropriate context.

8. **Session state**

* The system must track a per chat active session with:

  * Current step.
  * Minimal context for the current action.
  * Expiration time (inactivity timeout).
* The session must be cleared on:

  * Successful completion of an add action.
  * User cancellation.
  * Timeout expiry.

9. **Idempotency**

* The system must avoid duplicate operations if Green API delivers the same inbound message more than once.
* Product creation must not be executed more than once for the same confirmed user request.

10. **Backend requirements**

* Runtime: Node.js with **Fastify**.
* Architecture must support **dependency injection** so modules can be instantiated independently for unit testing.
* Modules must be separated by responsibility (example: HTTP server, webhook handler, flow controller, state store, WooCommerce client, SKU generator, parser, OpenAI client).

11. **Testing requirements**

* Each module must have **local unit tests**.
* Tests must run without external network calls by default, using mocks for:

  * WooCommerce HTTP client.
  * OpenAI client.
  * Green API webhook payloads.
  * State store.
* The test suite must cover:

  * Trigger routing.
  * Flow transitions.
  * Parsing and validation behavior.
  * SKU generation behavior.
  * Idempotency behavior.
  * Error responses.

12. **Non functional requirements**

* Replies must be short and operational.
* Secrets (Green API, WooCommerce, OpenAI) must not be exposed in logs or user messages.
